<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BTC 收款</title>
  <style>
    :root{--bg:#0b1220;--card:#0f1a30;--border:#243a67;--text:#e8eefc;--muted:#a9b7dc;--accent:#66d9ff;--bad:#ff6b6b;--ok:#4fffbf;}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#07101d,#0b1220);color:var(--text);font-family:"Microsoft YaHei",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap{max-width:860px;margin:0 auto;padding:28px 14px;}
    .card{background:rgba(15,26,48,.92);border:1px solid rgba(36,58,103,.8);border-radius:14px;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,.35);}
    h1{margin:0 0 8px;font-size:18px;letter-spacing:.3px;}
    .muted{color:var(--muted);font-size:13px;line-height:1.5;}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    input{flex:1;min-width:220px;border-radius:10px;border:1px solid rgba(42,71,127,.9);background:#0d1a33;color:var(--text);padding:10px 12px;font-size:14px;}
    button{border-radius:10px;border:1px solid rgba(42,71,127,.9);background:#0d1a33;color:var(--text);padding:10px 12px;font-size:14px;cursor:pointer;}
    button:hover{border-color:#3f67b3;}
    button.mid{border-color:rgba(102,217,255,.55);}
    button.mid:hover{border-color:rgba(102,217,255,.85);}
    .msg-warn{color:#ffe9ee;background:rgba(255,107,107,.12);border:1px solid rgba(255,107,107,.35);padding:10px;border-radius:12px;font-size:13px;}
    .msg-ok{color:#d9ffef;background:rgba(80,255,190,.08);border:1px solid rgba(80,255,190,.25);padding:10px;border-radius:12px;font-size:13px;}
    .addr{word-break:break-all;font-family:ui-monospace,Consolas,monospace;font-size:13px;background:rgba(255,255,255,.05);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.08);}
    a{color:var(--accent);text-decoration:none;}
    a:hover{text-decoration:underline;}
    .qr{margin-top:12px;display:flex;justify-content:center;}
    canvas{background:white;border-radius:12px;padding:10px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>BTC 收款</h1>
      <div class="muted">这是一个静态收款页：生成 <b>BIP21</b> 收款链接（bitcoin:...）。</div>

      <div style="margin-top:12px" class="muted">收款地址：</div>
      <div id="addr" class="addr"></div>

      <div class="row">
        <input id="amount" type="number" min="0" step="0.00000001" placeholder="金额（BTC，可选）" />
        <button id="btn">生成收款链接</button>
        <button id="copy">复制地址</button>
      </div>

      <div class="muted" style="margin-top:6px">快捷金额（白名单）：</div>
      <div class="row" style="margin-top:8px">
        <button class="amt" data-amt="0.00003414">0.00003414</button>
        <button class="amt mid" data-amt="0.00005678">0.00005678</button>
        <button class="amt" data-amt="0.00001234">0.00001234</button>
      </div>

      <div id="msg" class="muted" style="margin-top:10px"></div>

      <div style="margin-top:12px" class="muted">收款链接：</div>
      <div class="addr"><a id="link" href="#">（请点击“生成收款链接”）</a></div>

      <div class="qr"><canvas id="qr"></canvas></div>

      <div class="muted" style="margin-top:12px">
        提示：公开发布此页面会暴露你的收款地址并可被链上追踪。
      </div>
    </div>
  </div>

  <!-- 本地二维码库（无外部 CDN）：qrcode-generator -->
  <script src="./assets/qrcode-generator.js"></script>
  <script>
    // 你的收款地址
    const ADDRESS = 'bc1p26d9hh7fahfxe40pv394mewq7fazzaqwt427t59j2mcszpvhd0wql4682h';

    const addrEl = document.getElementById('addr');
    const amountEl = document.getElementById('amount');
    const linkEl = document.getElementById('link');
    const btn = document.getElementById('btn');
    const copyBtn = document.getElementById('copy');
    const msgEl = document.getElementById('msg');

    // 金额白名单（用于“金额归因”方案，禁止随意改尾差）
    const ALLOWED_AMOUNTS = ['0.00003414','0.00005678','0.00001234'];

    function setMsg(type, text){
      msgEl.className = '';
      msgEl.textContent = '';
      if(!text) return;
      msgEl.className = type === 'ok' ? 'msg-ok' : (type === 'warn' ? 'msg-warn' : 'muted');
      msgEl.textContent = text;
    }

    addrEl.textContent = ADDRESS;

    function makeBip21(){
      const amt = (amountEl.value || '').trim();

      // 允许为空；若填写金额，则必须在白名单内
      if (amt && !ALLOWED_AMOUNTS.includes(amt)) {
        return null;
      }

      let uri = 'bitcoin:' + ADDRESS;
      if (amt) uri += '?amount=' + encodeURIComponent(amt);
      return uri;
    }

    function drawQr(text){
      const c = document.getElementById('qr');
      const ctx = c.getContext('2d');

      // 生成二维码矩阵
      // 说明：qrcode(typeNumber, errorCorrectionLevel)
      // typeNumber=0 让库自动选择版本；纠错等级用 M（中等）
      const qr = qrcode(0, 'M');
      qr.addData(text);
      qr.make();

      const count = qr.getModuleCount();
      const cell = 6;
      const pad = 10;

      const size = count * cell + pad * 2;
      c.width = size;
      c.height = size;

      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, size, size);

      ctx.fillStyle = '#000';
      for (let r = 0; r < count; r++) {
        for (let col = 0; col < count; col++) {
          if (qr.isDark(r, col)) {
            ctx.fillRect(pad + col * cell, pad + r * cell, cell, cell);
          }
        }
      }
    }

    function refresh(){
      const uri = makeBip21();

      if (!uri) {
        linkEl.textContent = '（金额不在白名单，已禁止生成）';
        linkEl.href = '#';
        setMsg('warn', '提示：金额不在白名单内。请使用下方快捷金额按钮（中间按钮为推荐金额），或清空金额。');
        // 仍然生成“空金额”的二维码（地址），方便用户直接转账
        const uriNoAmt = 'bitcoin:' + ADDRESS;
        drawQr(uriNoAmt);
        return;
      }

      linkEl.textContent = uri;
      linkEl.href = uri;
      drawQr(uri);

      const amt = (amountEl.value || '').trim();
      if (amt) setMsg('ok', `已生成白名单金额收款链接：${amt} BTC`);
      else setMsg('ok', '已生成地址收款链接（未填写金额）。');
    }

    btn.addEventListener('click', refresh);

    document.querySelectorAll('button.amt').forEach(b=>{
      b.addEventListener('click', ()=>{
        const amt = b.getAttribute('data-amt');
        amountEl.value = amt;
        refresh();
      });
    });

    amountEl.addEventListener('input', ()=>{
      const amt = (amountEl.value || '').trim();
      if (!amt) { setMsg('', ''); return; }
      if (ALLOWED_AMOUNTS.includes(amt)) setMsg('ok', '金额在白名单内，可生成链接。');
      else setMsg('warn', '金额不在白名单内：将禁止生成（请用下方按钮）。');
    });

    copyBtn.addEventListener('click', async () => {
      try{
        await navigator.clipboard.writeText(ADDRESS);
        copyBtn.textContent = '已复制';
        setTimeout(()=>copyBtn.textContent='复制地址', 1200);
      }catch(e){
        alert('复制失败：' + e);
      }
    });

    refresh();
  </script>
</body>
</html>
